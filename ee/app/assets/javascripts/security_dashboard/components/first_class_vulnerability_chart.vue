<script>
import dateFormat from 'dateformat';
import { GlTooltipDirective, GlTable } from '@gitlab/ui';
import { GlSparklineChart } from '@gitlab/ui/dist/charts';
import SeverityBadge from 'ee/vue_shared/security_reports/components/severity_badge.vue';
import { s__, sprintf } from '~/locale';
import { firstAndLastY } from '~/lib/utils/chart_utils';
import { formattedChangeInPercent } from '~/lib/utils/number_utils';
import ChartButtons from './vulnerability_chart_buttons.vue';
import vulnerabilityHistoryQuery from '../graphql/instance_vulnerability_history.graphql';
import { DAY_IN_MS } from '../store/modules/vulnerabilities/constants';
import { SEVERITY_LEVELS } from '../store/constants';

const ISO_DATE = 'isoDate';
const DAYS = { thirty: 30, sixty: 60, ninety: 90 };

export default {
  components: {
    ChartButtons,
    GlSparklineChart,
    GlTable,
    SeverityBadge,
  },
  directives: {
    GlTooltip: GlTooltipDirective,
  },
  data() {
    return {
      vulnerabilitiesHistory: {},
      maximumDayIntervalAllowedByBackend: 10,
      vulnerabilitiesHistoryDayRange: DAYS.thirty,
      vulnerabilitiesHistoryMaxDayInterval: 7,
      errorLoadingVulnerabilitiesHistory: false,
      currentStartDateCursor: undefined,
      days: Object.values(DAYS),
    };
  },
  fields: [
    { key: 'severityLevel', label: s__('VulnerabilityChart|Severity'), tdClass: 'border-0' },
    { key: 'chartData', label: '', tdClass: 'border-0 w-100' },
    { key: 'changeInPercent', label: '%', thClass: 'text-right', tdClass: 'border-0 text-right' },
    {
      key: 'currentVulnerabilitiesCount',
      label: '#',
      thClass: 'text-right',
      tdClass: 'border-0 text-right',
    },
  ],
  severityLevels: [
    SEVERITY_LEVELS.critical,
    SEVERITY_LEVELS.high,
    SEVERITY_LEVELS.medium,
    SEVERITY_LEVELS.low,
  ].map(l => l.toLowerCase()),
  apollo: {
    vulnerabilitiesHistory: {
      query: vulnerabilityHistoryQuery,
      variables() {
        console.log(this.startDateCursor, dateFormat(this.startDateCursor, ISO_DATE));
        return {
          startDate: dateFormat(new Date(this.startDateCursor), ISO_DATE),
          endDate: dateFormat(new Date(this.endDateCursor), ISO_DATE),
        };
      },
      update({ vulnerabilitiesCountByDayAndSeverity }) {
        return vulnerabilitiesCountByDayAndSeverity.nodes.reduce(
          (acc, v) => {
            const severity = v.severity.toLowerCase();
            acc[severity] = acc[severity] || {};
            acc[severity][v.day] = v.count;
            return acc;
          },
          { ...this.vulnerabilitiesHistory },
        );
      },
      result() {
        console.log(this.vulnerabilitiesHistory);
        if (this.endDateCursor < Date.now()) {
          this.currentStartDateCursor = this.endDateCursor;
        }
      },
      error() {
        this.errorLoadingVulnerabilitiesHistory = true;
      },
    },
  },
  computed: {
    startDate() {
      return Date.now() - DAY_IN_MS * this.vulnerabilitiesHistoryDayRange;
    },
    startDateCursor() {
      return this.currentStartDateCursor || this.startDate;
    },
    endDateCursor() {
      return this.startDateCursor + DAY_IN_MS * (this.maximumDayIntervalAllowedByBackend - 1);
    },
    charts() {
      const { severityLevels } = this.$options;

      return severityLevels.map(severityLevel => {
        const history = Object.entries(this.vulnerabilitiesHistory[severityLevel] || {});
        const chartData = history.length ? history : this.emptyDataSet;
        const [pastCount, currentCount] = firstAndLastY(chartData);
        const changeInPercent = formattedChangeInPercent(pastCount, currentCount);

        return {
          severityLevel,
          chartData,
          changeInPercent,
          currentVulnerabilitiesCount: currentCount,
        };
      });
    },
    dateInfo() {
      const formattedStartDate = dateFormat(this.startDate, 'mmmm dS');
      return sprintf(s__('VulnerabilityChart|%{formattedStartDate} to today'), {
        formattedStartDate,
      });
    },
    emptyDataSet() {
      const formattedStartDate = dateFormat(this.startDate, ISO_DATE);
      const formattedEndDate = dateFormat(Date.now(), ISO_DATE);
      return [[formattedStartDate, 0], [formattedEndDate, 0]];
    },
  },
  watch: {
    startDateCursor() {
      this.$apollo.queries.vulnerabilitiesHistory.refetch();
    },
  },
  methods: {
    setVulnerabilitiesHistoryDayRange(days) {
      this.vulnerabilitiesHistoryDayRange = days;
      this.currentStartDateCursor = undefined;
    },
  },
};
</script>

<template>
  <section class="border rounded p-0">
    <div class="p-3">
      <header id="vulnerability-chart-header">
        <h4 class="my-0">
          {{ __('Vulnerabilities over time') }}
        </h4>
        <p ref="timeInfo" class="text-secondary mt-0 js-vulnerabilities-chart-time-info">
          {{ dateInfo }}
        </p>
      </header>
      <chart-buttons
        :days="days"
        :active-day="vulnerabilitiesHistoryDayRange"
        @click="setVulnerabilitiesHistoryDayRange"
      />
    </div>

    <gl-table
      :fields="$options.fields"
      :items="charts"
      :borderless="true"
      thead-class="thead-white"
      class="js-vulnerabilities-chart-severity-level-breakdown mb-2"
    >
      <template #head(changeInPercent)="{ label }">
        <span v-gl-tooltip :title="__('Difference between start date and now')">{{ label }}</span>
      </template>

      <template #head(currentVulnerabilitiesCount)="{ label }">
        <span v-gl-tooltip :title="__('Current vulnerabilities count')">{{ label }}</span>
      </template>

      <template #cell(severityLevel)="{ value }">
        <severity-badge :ref="`severityBadge${value}`" :severity="value" />
      </template>
      <template #cell(chartData)="{ item }">
        <div class="position-relative h-32-px">
          <gl-sparkline-chart
            :ref="`sparklineChart${item.severityLevel}`"
            :height="32"
            :data="item.chartData"
            :tooltip-label="__('Vulnerabilities')"
            :show-last-y-value="false"
            class="position-absolute w-100 position-top-0 position-left-0"
          />
        </div>
      </template>
      <template #cell(changeInPercent)="{ value }">
        <span ref="changeInPercent">{{ value }}</span>
      </template>
      <template #cell(currentVulnerabilitiesCount)="{ value }">
        <span ref="currentVulnerabilitiesCount">{{ value }}</span>
      </template>
    </gl-table>
  </section>
</template>
