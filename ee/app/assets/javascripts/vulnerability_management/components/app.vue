<script>
import { GlLoadingIcon, GlBadge, GlLink, GlSprintf } from '@gitlab/ui';
import axios from '~/lib/utils/axios_utils';
import createFlash from '~/flash';
import { s__ } from '~/locale';
import TimeAgoTooltip from '~/vue_shared/components/time_ago_tooltip.vue';
import VulnerabilityStateDropdown from './vulnerability_state_dropdown.vue';
import { VULNERABILITY_STATES } from '../constants';

export default {
  name: 'VulnerabilityManagementApp',
  components: {
    GlLoadingIcon,
    GlBadge,
    GlLink,
    GlSprintf,
    TimeAgoTooltip,
    VulnerabilityStateDropdown,
  },

  props: {
    vulnerability: { type: Object, required: true },
    pipeline: { type: Object, required: true },
  },

  data() {
    return {
      isLoading: false,
      state: this.vulnerability.state,
    };
  },

  computed: {
    variant() {
      // Get the badge variant based on the vulnerability state, defaulting to 'warning'.
      const state = VULNERABILITY_STATES[this.state];
      return (state && state.variant) || 'warning';
    },
  },

  methods: {
    resetLoadingState(timer) {
      clearTimeout(timer);
      this.isLoading = false;
    },

    onVulnerabilityStateChange(newState) {
      const loadingTimer = setTimeout(() => {
        this.isLoading = true;
      }, 200);

      axios
        .post(`${this.vulnerability.url}/${this.vulnerability.id}/${newState}`)
        .then(({ data }) => {
          this.resetLoadingState(loadingTimer);
          this.state = data.state;
        })
        .catch(() => {
          this.resetLoadingState(loadingTimer);
          createFlash(
            s__(
              'VulnerabilityManagement|Something went wrong, could not update vulnerability state.',
            ),
          );
        });
    },
  },
};
</script>

<template>
  <div>
    <div class="d-flex align-items-center border-bottom pt-2 pb-2">
      <gl-loading-icon v-if="isLoading" />
      <gl-badge v-else ref="badge" class="text-capitalize" :variant="variant">{{ state }}</gl-badge>

      <span v-if="pipeline.url" class="ml-2">
        <gl-sprintf :message="__('Detected %{timeago} in pipeline %{pipelineLink}')">
          <template #timeago
            ><time-ago-tooltip :time="pipeline.created_at"
          /></template>
          <template #pipelineLink
            ><gl-link :href="pipeline.url" target="_blank">{{ pipeline.id }}</gl-link></template
          >
        </gl-sprintf>
      </span>

      <time-ago-tooltip v-else :time="vulnerability.created_at" />

      <label class="mb-0 ml-auto mr-2">{{ __('Status') }}</label>
      <gl-loading-icon v-if="isLoading" />
      <vulnerability-state-dropdown v-else :state="state" @change="onVulnerabilityStateChange" />
    </div>

    <slot name="details"></slot>
  </div>
</template>
