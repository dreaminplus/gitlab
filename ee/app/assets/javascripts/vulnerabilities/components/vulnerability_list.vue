<script>
import { s__, __ } from '~/locale';
import { GlEmptyState, GlFormCheckbox, GlLink, GlSkeletonLoading, GlTable } from '@gitlab/ui';
import RemediatedBadge from './remediated_badge.vue';
import SeverityBadge from 'ee/vue_shared/security_reports/components/severity_badge.vue';
import SelectionSummary from 'ee/security_dashboard/components/selection_summary.vue';
import { VULNERABILITIES_PER_PAGE } from '../constants';

export default {
  name: 'VulnerabilityList',
  components: {
    GlEmptyState,
    GlFormCheckbox,
    GlLink,
    GlSkeletonLoading,
    GlTable,
    RemediatedBadge,
    SelectionSummary,
    SeverityBadge,
  },
  props: {
    dashboardDocumentation: {
      type: String,
      required: true,
    },
    emptyStateSvgPath: {
      type: String,
      required: true,
    },
    refetchVulnerabilities: {
      type: Function,
      required: false,
      default: null,
    },
    vulnerabilities: {
      type: Array,
      required: true,
    },
    isLoading: {
      type: Boolean,
      required: false,
      default: false,
    },
  },
  data: () => ({
    selectedVulnerabilities: {},
  }),
  computed: {
    hasSelectedAllVulnerabilities() {
      return this.numOfSelectedVulnerabilities === this.vulnerabilities.length;
    },
    numOfSelectedVulnerabilities() {
      return Object.keys(this.selectedVulnerabilities).length;
    },
    shouldShowSelectionSummary() {
      return this.shouldShowSelection && Boolean(this.numOfSelectedVulnerabilities);
    },
    shouldShowSelection() {
      return Boolean(this.refetchVulnerabilities);
    },
    checkboxClass() {
      return this.shouldShowSelection ? 'gl-w-8' : 'd-none';
    },
  },
  fields: [
    {
      key: 'checkbox',
    },
    {
      key: 'state',
      label: s__('Vulnerability|Status'),
      thClass: 'gl-w-64',
    },
    {
      key: 'severity',
      label: s__('Vulnerability|Severity'),
      thClass: 'gl-w-64',
    },
    {
      key: 'title',
      label: __('Description'),
    },
  ],
  mounted() {
    const checkboxField = this.$options.fields.find(field => field.key === 'checkbox');
    checkboxField.class = this.checkboxClass;
  },
  methods: {
    deselectAllVulnerabilities() {
      this.selectedVulnerabilities = {};
    },
    isSelected(vulnerability = {}) {
      return Boolean(this.selectedVulnerabilities[vulnerability.id]);
    },
    selectAllVulnerabilities() {
      this.selectedVulnerabilities = this.vulnerabilities.reduce((acc, curr) => {
        acc[curr.id] = curr;
        return acc;
      }, {});
    },
    toggleAllVulnerabilities() {
      if (this.hasSelectedAllVulnerabilities) {
        this.deselectAllVulnerabilities();
      } else {
        this.selectAllVulnerabilities();
      }
    },
    toggleVulnerability(vulnerability) {
      if (!vulnerability) return;

      this.selectedVulnerabilities = { ...this.selectedVulnerabilities };
      if (this.selectedVulnerabilities[vulnerability.id]) {
        delete this.selectedVulnerabilities[vulnerability.id];
      } else {
        this.selectedVulnerabilities[vulnerability.id] = vulnerability;
      }
    },
  },
  VULNERABILITIES_PER_PAGE,
};
</script>

<template>
  <div>
    <selection-summary
      v-if="shouldShowSelectionSummary"
      :refetch-vulnerabilities="refetchVulnerabilities"
      :selected-vulnerabilities="Object.values(selectedVulnerabilities)"
      :deselect-all-vulnerabilities="deselectAllVulnerabilities"
    />
    <gl-table
      :busy="isLoading"
      :fields="$options.fields"
      :items="vulnerabilities"
      stacked="sm"
      show-empty
      responsive
    >
      <template v-slot:head(checkbox)>
        <gl-form-checkbox
          :checked="hasSelectedAllVulnerabilities"
          class="my-0 ml-1 mr-3"
          @change="toggleAllVulnerabilities"
        />
      </template>

      <template #cell(checkbox)="{ item }">
        <gl-form-checkbox
          :checked="isSelected(item)"
          class="my-0 ml-1 mr-3"
          @change="() => toggleVulnerability(item)"
        />
      </template>

      <template #cell(state)="{ item }">
        <span class="text-capitalize js-status">{{ item.state.toLowerCase() }}</span>
      </template>

      <template #cell(severity)="{ item }">
        <severity-badge class="js-severity" :severity="item.severity" />
      </template>

      <template #cell(title)="{ item }">
        <gl-link class="text-body js-description" :href="item.vulnerabilityPath">
          {{ item.title }}
        </gl-link>
        <remediated-badge v-if="item.resolved_on_default_branch" class="ml-2" />
      </template>

      <template #table-busy>
        <gl-skeleton-loading
          v-for="n in $options.VULNERABILITIES_PER_PAGE"
          :key="n"
          class="m-2 js-skeleton-loader"
          :lines="2"
        />
      </template>

      <template #empty>
        <slot name="emptyState">
          <gl-empty-state
            :title="s__(`We've found no vulnerabilities`)"
            :description="
              s__(
                `While it's rare to have no vulnerabilities, it can happen. In any event, we ask that you please double check your settings to make sure you've set up your dashboard correctly.`,
              )
            "
          />
        </slot>
      </template>
    </gl-table>
  </div>
</template>
